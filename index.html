<script>
        let liveStatusMemory = {}; 
        let isRefreshing = false;

        // FUNGSI REFRESH MANUAL (HARD REFRESH)
        function manualRefresh() {
            if (isRefreshing) return; 
            
            isRefreshing = true;
            const btn = document.getElementById('btnRefresh');
            btn.classList.add('spin-anim');
            
            // Logika Baru: Kirim parameter 'true' untuk memaksa update detik ini juga
            muatData(true).then(() => {
                setTimeout(() => {
                    btn.classList.remove('spin-anim');
                    isRefreshing = false;
                }, 1000); // Animasi minimal 1 detik
            });
        }

        // MENERIMA PARAMETER 'force'
        async function muatData(force = false) {
            try {
                let antiCache;
                
                if (force) {
                    // JIKA MANUAL: Pakai waktu detik ini juga (Anti-Cache Ekstrem)
                    antiCache = "&t=" + Date.now();
                } else {
                    // JIKA OTOMATIS: Pakai blok 12 detik (Hemat Kuota)
                    antiCache = "&t=" + Math.floor(Date.now() / 12000);
                }
                
                const respJ = await fetch(LINK_JADWAL + antiCache);
                const textJ = await respJ.text();
                const dataJadwal = csvKeJson(textJ);
                tampilkanJadwal(dataJadwal);
                tampilkanBagan(dataJadwal);

                const respK = await fetch(LINK_KLASEMEN + antiCache);
                const textK = await respK.text();
                const dataKlasemen = csvKeJson(textK);
                tampilkanKlasemen(dataKlasemen);
            } catch (e) { console.error("Error:", e); }
        }

        function csvKeJson(csv) {
            const baris = csv.split('\n').filter(line => line.trim() !== '');
            const headers = baris[0].split(',').map(h => h.trim());
            return baris.slice(1).map(line => {
                const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                let obj = {};
                headers.forEach((h, i) => {
                    let val = values[i] || '';
                    val = val.replace(/^"|"$/g, '').trim(); 
                    obj[h] = val;
                });
                return obj;
            });
        }

        function createMatchCard(m, isBagan) {
            let skornya = (m.Skor_A && m.Skor_B) ? `${m.Skor_A} - ${m.Skor_B}` : "VS";
            
            // LOGIKA STATUS
            let rawStatus = (m.Status || "").toLowerCase();
            let isLive = rawStatus.includes("live");
            let isSelesai = rawStatus.includes("selesai") || rawStatus.includes("final");
            
            let isVs = (skornya === "VS");
            let scoreClass = isVs ? "score-pill empty" : "score-pill";
            
            let cardClass = "";
            if (isLive) cardClass = "is-live";
            else if (isSelesai) cardClass = "is-finished"; 

            let infoHTML = "";
            if (isLive) {
                infoHTML = `<div class="live-indicator"><div class="dot-live"></div> LIVE</div>`;
            } else {
                let parts = [];
                if(m.Jam) parts.push(`Jam: ${m.Jam}`);
                if(m.Court) parts.push(`Court ${m.Court}`);
                infoHTML = `<div class="meta-right">${parts.join(' &nbsp;|&nbsp; ')}</div>`;
            }

            return `
            <div class="match-card ${cardClass}">
                <div class="match-meta">
                    <div class="meta-left">
                        <span class="babak-pill">${m.Babak}</span>
                        ${isLive ? '' : `<span style="font-size:10px; font-weight:600;">${m.Tanggal}</span>`}
                    </div>
                    ${infoHTML}
                </div>
                
                <div class="match-body">
                    <div class="team left">${m.Team_A || '...'}</div>
                    <div class="${scoreClass}">${skornya}</div>
                    <div class="team right">${m.Team_B || '...'}</div>
                </div>
            </div>`;
        }

        function tampilkanJadwal(data) {
            const div = document.getElementById('jadwal-content');
            div.innerHTML = "";
            document.getElementById('loading').style.display = 'none';
            let count = 0;
            data.forEach(m => {
                if(m.Babak.includes('QF') || m.Babak.includes('SF') || m.Babak.includes('Final')) return;
                div.innerHTML += createMatchCard(m, false);
                count++;
            });
            if(count === 0) div.innerHTML = '<p style="text-align:center; color:#888; font-size:12px;">Belum ada jadwal penyisihan.</p>';
        }

        function tampilkanBagan(data) {
            const div = document.getElementById('bagan-content');
            const dataBagan = data.filter(m => m.Babak.includes('QF') || m.Babak.includes('SF') || m.Babak.includes('Final'));
            if(dataBagan.length > 0) {
                div.innerHTML = ""; 
                dataBagan.forEach(m => { div.innerHTML += createMatchCard(m, true); });
            }
        }

        function tampilkanKlasemen(data) {
            let grupData = {};
            data.forEach(p => {
                if(!grupData[p.Grup]) grupData[p.Grup] = [];
                grupData[p.Grup].push(p);
            });

            const div = document.getElementById('klasemen-content');
            div.innerHTML = "";

            for (let grup in grupData) {
                grupData[grup].sort((a,b) => (b.Menang - a.Menang) || (b.Selisih_Game - a.Selisih_Game));
                
                let barisHtml = "";
                grupData[grup].forEach((Tim, index) => {
                    let statusCek = (Tim.Status || Tim.Poin || "").toLowerCase();
                    let rowClass = "";
                    if (statusCek.includes("win") || statusCek.includes("lolos")) {
                        rowClass = 'class="status-win"';
                    }
                    
                    barisHtml += `<tr ${rowClass}>
                        <td>${index + 1}</td>
                        <td>${Tim.Nama_Pasangan}</td>
                        <td>${Tim.Main || 0}</td>
                        <td>${Tim.Menang || 0}</td>
                        <td>${Tim.Kalah || 0}</td>
                        <td>${Tim.Selisih_Game || 0}</td>
                    </tr>`;
                });

                div.innerHTML += `
                <div class="grup-card">
                    <div class="grup-header">Grup ${grup}</div>
                    <table>
                        <thead>
                            <tr>
                                <th width="10">#</th>
                                <th>TIM</th>
                                <th width="10%" title="Matches">MP</th>
                                <th width="10%" title="Win">W</th>
                                <th width="10%" title="Lose">L</th>
                                <th width="10%" title="Diff">GD</th>
                            </tr>
                        </thead>
                        <tbody>${barisHtml}</tbody>
                    </table>
                </div>`;
            }
        }

        function bukaHalaman(id) {
            localStorage.setItem('halamanTerakhir', id);
            document.querySelectorAll('.container').forEach(e => e.classList.add('hidden'));
            document.getElementById('view-' + id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('nav-' + id).classList.add('active');
        }

        const lastPage = localStorage.getItem('halamanTerakhir') || 'jadwal';
        bukaHalaman(lastPage);

        muatData();
        setInterval(muatData, 12000); 
    </script>
